function gototop(t){"EXP"==action_type&&$("body,html").animate({scrollTop:80},500),("WORK"==action_type&&"coverfile"==t||"pic"==t)&&$("body,html").animate({scrollTop:80},500)};
function checkFile(){return coverfile?coverfile:(errorTip("请上传封面"),!1)}
function changefilevalue(t){coverfile=""!==$.trim(t.value)?!0:!1}
function checkpiclist(){return $("#queue li").length>1?!0:(errorTip("请上传作品图片"),!1)}
function checktype(){return 0==$.trim($("input[name=typeid]").val())?(errorTip("请选择分类"),!1):!0}
function checkAttribute(){return 0==$.trim($("input[name=attribute]").val())?(errorTip("请选择分类属性"),!1):!0}
function checkTitle(){return 0==$.trim($("input[name=title]").val())?(errorTip("请填写作品标题"),$("input[name=title]").focus(),!1):!0}
function checkContent(){var t=$("#contents").editable("getHTML");return 0==$.trim(t).length?(errorTip("请写文章内容"),$("#contents").editable("focus"),!1):!0}
function checkCopy(){return 0==$.trim($("input[name=copyright]").val())?(errorTip("请选择版权"),!1):!0}
//初步检验作品数据
$(function(){$form=$("#myForm"),$("#save,.save").click(function(){
    $(this).addClass('loading');
    $(this).text('');
    $(".loading").css("height","20px");
    $.ajax({url:"/save",
        type:"post",
        data:$form.serialize()+"&submit=save&type="+action_type+"&acl="+acl+"&havecheck="+1,
        dataType:"json",
        success:function(t){
            if(t.code == 1){
                if(confirm("上传时间已过，点击“确定”您的作品将作为普通作品发布 点击“取消”您的作品将不会被发布")){
                    bClick();
                }else{
                    window.location.href='http://activity.ui.cn/';
                }
            }
            // if(t.code == 2){
            //     setTimeout(function(){
            //         errorTip(t.msg);
            //     },3000);
            //     bClick();
            // }
            // if(t.code == 3){
            //     errorTip(t.msg);
            // }
            if(t.code == 4){
                $("#save").removeClass("loading");
                $("#save").text("发布作品");
                bClick();
            }
        }
    })
})})
//初步检验经验数据
$(function(){
    $("#edt-main .froala-view").on('keyup', function(e) {
        var new_val = $("#edt-main .froala-view").html();
        $("#contents").val(new_val);
    });
    $form=$("#myForm"),$("#save_e,.save_e").click(function(){
    $(this).addClass('loading');
    $(this).text('');
    $(".loading").css("height","50px");
    $.ajax({url:"/save",
        type:"post",
        data:$form.serialize()+"&submit=save&type="+action_type+"&acl="+acl+"&havecheck="+1,
        dataType:"json",
        success:function(t){
            if(t.code == 1){
                if(confirm("上传时间已过，点击“确定”您的作品将作为普通作品发布 点击“取消”您的作品将不会被发布")){
                    ExpClick();
                }else{
                    window.location.href='http://activity.ui.cn/';
                }
            }
            if(t.code == 2){
                setTimeout(function(){
                    errorTip(t.msg);
                },3000);
                ExpClick();
            }
            if(t.code == 3){
                errorTip(t.msg);
            }
            if(t.code == 4){
                ExpClick();
                $("#save_e").removeClass("loading");
                $("#save_e").html('<i class="icon-feiji" style="display: inline-block;vertical-align: middle;color: white;font-size: 28px;margin-right: 10px;margin-top: -2px"></i>立即发布');
            }
        }
    })
})})

//检验作品数据，并发布
function bClick(){
        if(!checkFile()){
            return gototop("coverfile"),!1;
        }
        if(projectfile&&!checkpiclist()){
            return gototop("pic"),!1;
        }
        if(!checktype()){
            return gototop(),!1;
        }
        if(!checkAttribute())
            return gototop(),!1;
        if(!checkTitle()){
            return gototop(),!1;
        }
        if(!checkCopy()){
            return gototop(),!1;
        }
        if(content){if(!checkContent())return !1;$("#contents").val($("#contents").editable("getHTML",!1,!1))}return $("#introduction").val($("#introduction").editable("getHTML",!1,!1)),
        $.ajax({url:"/save",
            type:"post",
            data:$form.serialize()+"&submit=save&type="+action_type+"&acl="+acl,
            dataType:"json",
            success:function(t){
                ("coverfile"==t.obj||"pic"==t.obj)&&$("body,html").animate({scrollTop:80},500),"EXP"==action_type&&$("body,html").animate({scrollTop:80},500),
                $("input[name="+t.obj+"]").focus(),globalTip(t);
                if(t.code == 200){
                    errorTip(t.msg);
                }
            },
                error:function(){}}),!1;var coverfile=!1;
};


//检验作品数据，并发布
function ExpClick(){
        if(!checkFile()){
            $("#save_e").removeClass("loading");
            $("#save_e span").html('<i class="icon-feiji" style="display: inline-block;vertical-align: middle;color: white;font-size: 28px;margin-right: 10px;margin-top: -2px"></i>立即发布');
            return gototop("coverfile"),!1;
        }
        if(!checktype()){
            $("#save_e").removeClass("loading");
            $("#save_e span").html('<i class="icon-feiji" style="display: inline-block;vertical-align: middle;color: white;font-size: 28px;margin-right: 10px;margin-top: -2px"></i>立即发布');
            return gototop(),!1;
        }
        if(!checkAttribute()){
            $("#save_e").removeClass("loading");
            $("#save_e span").html('<i class="icon-feiji" style="display: inline-block;vertical-align: middle;color: white;font-size: 28px;margin-right: 10px;margin-top: -2px"></i>立即发布');
            return gototop(),!1;
        }
        if(!checkTitle()){
            $("#save_e").removeClass("loading");
            $("#save_e span").html('<i class="icon-feiji" style="display: inline-block;vertical-align: middle;color: white;font-size: 28px;margin-right: 10px;margin-top: -2px"></i>立即发布');
            return gototop(),!1;
        }
        if(!checkCopy()){
            $("#save_e").removeClass("loading");
            $("#save_e span").html('<i class="icon-feiji" style="display: inline-block;vertical-align: middle;color: white;font-size: 28px;margin-right: 10px;margin-top: -2px"></i>立即发布');
            return gototop(),!1;
        }
        if($("#contents").val()==""){
            $("#save_e").removeClass('loading');
            $("#save_e span").html('<i class="icon-feiji" style="display: inline-block;vertical-align: middle;color: white;font-size: 28px;margin-right: 10px;margin-top: -2px"></i>立即发布');
        }
        if(content){if(!checkContent())return !1;$("#contents").val($("#contents").editable("getHTML",!1,!1))}return $("#introduction").val($("#introduction").editable("getHTML",!1,!1)),
        $.ajax({url:"/save",
            type:"post",
            data:$form.serialize()+"&submit=save&type="+action_type+"&acl="+acl,
            dataType:"json",
            success:function(t){
                ("coverfile"==t.obj||"pic"==t.obj)&&$("body,html").animate({scrollTop:80},500),"EXP"==action_type&&$("body,html").animate({scrollTop:80},500),
                $("input[name="+t.obj+"]").focus(),globalTip(t);
                if(t.code == 200){
                    errorTip(t.msg);
                }
            },
                error:function(){}}),!1;var coverfile=!1;
};

//预览作品
$(function(){
    var $form=$("#myForm");
    $("#preview_p,#preview_button").click(function(){
        $(this).addClass('loading');
        $(this).text('');
        $(".loading").css("height","20px");
    if(!checkFile()){
        $(this).removeClass('loading');
        $(this).text('预览作品');
        return gototop("coverfile"),!1;
    }
    if(projectfile&&!checkpiclist()){
        $(this).removeClass('loading');
        $(this).text('预览作品');
        return gototop("pic"),!1;
    }
    if(!checktype()){
        $(this).removeClass('loading');
        $(this).text('预览作品');
        return gototop(),!1;
    }
    if(!checkAttribute()){
        $(this).removeClass('loading');
        $(this).text('预览作品');
        return gototop(),!1;
    }
    if(!checkTitle()){
        $(this).removeClass('loading');
        $(this).text('预览作品');
        return gototop(),!1;
    }
    if(!checkCopy()){
        $(this).removeClass('loading');
        $(this).text('预览作品');
        return gototop(),!1;
    }
    if(content){if(!checkContent())return gototop(),!1;$("#contents").val($("#contents").editable("getHTML",!1,!1))}return $("#introduction").val($("#introduction").editable("getHTML",!1,!1)),
    $.ajax({url:"/savepreview",
        type:"post",
        data:$form.serialize()+"&submit=save&type="+action_type+"&acl="+acl,
        dataType:"json",
        success:function(t){
//            ("coverfile"==t.obj||"pic"==t.obj)&&$("body,html").animate({scrollTop:80},500),"EXP"==action_type&&$("body,html").animate({scrollTop:80},500),
//            $("input[name="+t.obj+"]").focus(),
            globalTip(t);
            $("#preview_p").removeClass("loading");
            $("#preview_p").text("预览作品");
        },
        error:function(){}}),!1;var coverfile=!1;        
    })
})

//预览经验
$(function(){
    var $form=$("#myForm");
    $("#preview_e,#preview_e_button").click(function(){
        $(this).addClass('loading');
        $(this).text('');
        $(".loading").css("height","20px");
    if(!checkFile()){
        $(this).removeClass('loading');
        $(this).text('预览经验');
        return gototop("coverfile"),!1;
    }
    if(!checktype()){
        $(this).removeClass('loading');
        $(this).text('预览经验');
        return gototop(),!1;
    }
    if(!checkAttribute()){
        $(this).removeClass('loading');
        $(this).text('预览经验');
        return gototop(),!1;
    }
    if(!checkTitle()){
        $(this).removeClass('loading');
        $(this).text('预览经验');
        return gototop(),!1;
    }
    if(!checkCopy()){
        $(this).removeClass('loading');
        $(this).text('预览经验');
        return gototop(),!1;
    }
    if($("#contents").val()==""){
        $(this).removeClass('loading');
        $(this).text('预览经验');
    }
    if(content){if(!checkContent())return !1;$("#contents").val($("#contents").editable("getHTML",!1,!1))}return $("#introduction").val($("#introduction").editable("getHTML",!1,!1)),
    $.ajax({url:"/savepreview",
        type:"post",
        data:$form.serialize()+"&submit=save&type="+action_type+"&acl="+acl,
        dataType:"json",
        success:function(t){
//            ("coverfile"==t.obj||"pic"==t.obj)&&$("body,html").animate({scrollTop:80},500),"EXP"==action_type&&$("body,html").animate({scrollTop:80},500),
//            $("input[name="+t.obj+"]").focus(),
            globalTip(t);
            $("#preview_e").removeClass("loading");
            $("#preview_e").text("预览经验");
        },
        error:function(){}}),!1;var coverfile=!1;        
    })
})

//预览  直接发布
$(function(){
    $("#preview_publish").click(function(){
        $(this).addClass('loading');
        $(this).text('');
        var id = $("input[name=saveproid]").val();
        $.ajax({url:"/prevpublish",
            type:"post",
            data:{'id':id,'submit':'preview','acl':acl},
            dataType:"json",
            success:function(t){
            	console.log(t);
                globalTip(t);
            },
            error:function(){}
        })
    })
})
$(".up-cover-pic").click(function () {
    $(".required").trigger("click");
})
